name: Notify Slides - Discord & Email (PPTX + PDF)

on:
  push:
    paths:
      - "downloads/pptx/*.pptx"
      - "downloads/pdf/*.pdf"

permissions:
  contents: write

jobs:
  process-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect new files
        id: detect
        run: |
          # ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆã§è¿½åŠ ãƒ»å¤‰æ›´ã•ã‚ŒãŸ PPTX / PDF ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          PPTX_FILES=$(git diff --name-only HEAD~1 HEAD -- 'downloads/pptx/*.pptx' || true)
          PDF_FILES=$(git diff --name-only HEAD~1 HEAD -- 'downloads/pdf/*.pdf' || true)

          if [ -z "$PPTX_FILES" ] && [ -z "$PDF_FILES" ]; then
            echo "No new slide files found."
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "found=true" >> "$GITHUB_OUTPUT"

          # PPTX ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
          if [ -n "$PPTX_FILES" ]; then
            echo "pptx_found=true" >> "$GITHUB_OUTPUT"
            FIRST_PPTX=$(echo "$PPTX_FILES" | head -1)
            PPTX_BASENAME=$(basename "$FIRST_PPTX")
            echo "first_pptx=$FIRST_PPTX" >> "$GITHUB_OUTPUT"
            echo "pptx_basename=$PPTX_BASENAME" >> "$GITHUB_OUTPUT"
            # æ‹¡å¼µå­ãªã—ã®åå‰ï¼ˆPDFå¤‰æ›ç”¨ï¼‰
            STEM="${PPTX_BASENAME%.pptx}"
            echo "stem=$STEM" >> "$GITHUB_OUTPUT"
          else
            echo "pptx_found=false" >> "$GITHUB_OUTPUT"
          fi

          # PDF ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
          if [ -n "$PDF_FILES" ]; then
            echo "pdf_found=true" >> "$GITHUB_OUTPUT"
            FIRST_PDF=$(echo "$PDF_FILES" | head -1)
            PDF_BASENAME=$(basename "$FIRST_PDF")
            echo "first_pdf=$FIRST_PDF" >> "$GITHUB_OUTPUT"
            echo "pdf_basename=$PDF_BASENAME" >> "$GITHUB_OUTPUT"
          else
            echo "pdf_found=false" >> "$GITHUB_OUTPUT"
          fi

      # =============================================
      # PPTX â†’ PDF è‡ªå‹•å¤‰æ›ï¼ˆPDFãŒã¾ã ãªã„å ´åˆï¼‰
      # =============================================
      - name: Install LibreOffice
        if: steps.detect.outputs.pptx_found == 'true'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq libreoffice-impress

      - name: Convert PPTX to PDF
        if: steps.detect.outputs.pptx_found == 'true'
        id: convert
        run: |
          STEM="${{ steps.detect.outputs.stem }}"
          PPTX_PATH="${{ steps.detect.outputs.first_pptx }}"
          PDF_PATH="downloads/pdf/${STEM}.pdf"

          if [ ! -f "$PDF_PATH" ]; then
            echo "Converting $PPTX_PATH to PDF..."
            libreoffice --headless --convert-to pdf --outdir downloads/pdf/ "$PPTX_PATH"
            if [ -f "$PDF_PATH" ]; then
              echo "converted=true" >> "$GITHUB_OUTPUT"
              echo "pdf_path=$PDF_PATH" >> "$GITHUB_OUTPUT"
              echo "pdf_basename=${STEM}.pdf" >> "$GITHUB_OUTPUT"
            else
              echo "::warning::PDF conversion failed for $PPTX_PATH"
              echo "converted=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "PDF already exists: $PDF_PATH"
            echo "converted=false" >> "$GITHUB_OUTPUT"
            echo "pdf_path=$PDF_PATH" >> "$GITHUB_OUTPUT"
            echo "pdf_basename=${STEM}.pdf" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit auto-generated PDF
        if: steps.convert.outputs.converted == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add downloads/pdf/
          git commit -m "Auto-generate PDF: ${{ steps.convert.outputs.pdf_basename }}"
          git push

      # =============================================
      # é€šçŸ¥ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®ç¢ºå®š
      # =============================================
      - name: Resolve file paths for notification
        id: resolve
        run: |
          # PPTX ãƒ‘ã‚¹
          if [ "${{ steps.detect.outputs.pptx_found }}" == "true" ]; then
            echo "pptx_path=${{ steps.detect.outputs.first_pptx }}" >> "$GITHUB_OUTPUT"
            echo "pptx_basename=${{ steps.detect.outputs.pptx_basename }}" >> "$GITHUB_OUTPUT"
          fi

          # PDF ãƒ‘ã‚¹ï¼ˆå¤‰æ›æ¸ˆã¿ or ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã‚‚ã®ï¼‰
          if [ "${{ steps.convert.outputs.pdf_path }}" != "" ]; then
            echo "pdf_path=${{ steps.convert.outputs.pdf_path }}" >> "$GITHUB_OUTPUT"
            echo "pdf_basename=${{ steps.convert.outputs.pdf_basename }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ steps.detect.outputs.pdf_found }}" == "true" ]; then
            echo "pdf_path=${{ steps.detect.outputs.first_pdf }}" >> "$GITHUB_OUTPUT"
            echo "pdf_basename=${{ steps.detect.outputs.pdf_basename }}" >> "$GITHUB_OUTPUT"
          fi

          # é€šçŸ¥ç”¨ã®ãƒ™ãƒ¼ã‚¹åï¼ˆæ‹¡å¼µå­ãªã—ï¼‰
          if [ "${{ steps.detect.outputs.pptx_found }}" == "true" ]; then
            echo "display_name=${{ steps.detect.outputs.pptx_basename }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ steps.detect.outputs.pdf_found }}" == "true" ]; then
            echo "display_name=${{ steps.detect.outputs.pdf_basename }}" >> "$GITHUB_OUTPUT"
          fi

      # =============================================
      # Discord é€ä¿¡ï¼ˆWebhookçµŒç”±ï¼‰- PPTX + PDF
      # =============================================
      - name: Send to Discord
        if: steps.detect.outputs.found == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "::warning::DISCORD_WEBHOOK_URL is not set. Skipping Discord notification."
            exit 0
          fi

          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          COMMIT_MSG=$(git log -1 --pretty=%s)
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          DISPLAY_NAME="${{ steps.resolve.outputs.display_name }}"

          # æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹ç¯‰
          FILE_ARGS=""
          FILE_INDEX=0
          ATTACH_TEXT=""

          PPTX_PATH="${{ steps.resolve.outputs.pptx_path }}"
          PDF_PATH="${{ steps.resolve.outputs.pdf_path }}"

          if [ -n "$PPTX_PATH" ] && [ -f "$PPTX_PATH" ]; then
            FILE_ARGS="$FILE_ARGS -F files[$FILE_INDEX]=@$PPTX_PATH"
            ATTACH_TEXT="$ATTACH_TEXT\nğŸ“Š PPTX: ${{ steps.resolve.outputs.pptx_basename }}"
            FILE_INDEX=$((FILE_INDEX + 1))
          fi

          if [ -n "$PDF_PATH" ] && [ -f "$PDF_PATH" ]; then
            FILE_ARGS="$FILE_ARGS -F files[$FILE_INDEX]=@$PDF_PATH"
            ATTACH_TEXT="$ATTACH_TEXT\nğŸ“„ PDF: ${{ steps.resolve.outputs.pdf_basename }}"
            FILE_INDEX=$((FILE_INDEX + 1))
          fi

          # Discord Embed ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
          curl -s $FILE_ARGS \
          -F "payload_json={
            \"embeds\": [{
              \"title\": \"ğŸ“Š æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ãŒä½œæˆã•ã‚Œã¾ã—ãŸ\",
              \"description\": \"**${DISPLAY_NAME}**\n\nã‚³ãƒŸãƒƒãƒˆ: ${COMMIT_MSG}${ATTACH_TEXT}\",
              \"color\": 854563,
              \"fields\": [
                {\"name\": \"ãƒªãƒã‚¸ãƒˆãƒª\", \"value\": \"${REPO}\", \"inline\": true},
                {\"name\": \"ãƒ–ãƒ©ãƒ³ãƒ\", \"value\": \"${BRANCH}\", \"inline\": true},
                {\"name\": \"ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\", \"value\": \"[GitHub ã§é–‹ã](${COMMIT_URL})\", \"inline\": false}
              ],
              \"footer\": {\"text\": \"Sincerely Slide Skill V2\"}
            }]
          }" \
          "$DISCORD_WEBHOOK_URL"

          echo "Discord ã«é€ä¿¡ã—ã¾ã—ãŸ: $DISPLAY_NAME (PPTX + PDF)"

      # =============================================
      # ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆSMTPçµŒç”±ï¼‰- PPTX + PDF æ·»ä»˜
      # =============================================
      - name: Check email password
        id: email_check
        env:
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        run: |
          if [ -z "$MAIL_PASSWORD" ]; then
            echo "::warning::MAIL_PASSWORD ãŒæœªè¨­å®šã®ãŸã‚ã€ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            echo "configured=false" >> "$GITHUB_OUTPUT"
          else
            echo "configured=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Build attachment list
        if: steps.detect.outputs.found == 'true' && steps.email_check.outputs.configured == 'true'
        id: attachments
        run: |
          ATTACH=""
          PPTX_PATH="${{ steps.resolve.outputs.pptx_path }}"
          PDF_PATH="${{ steps.resolve.outputs.pdf_path }}"

          if [ -n "$PPTX_PATH" ] && [ -f "$PPTX_PATH" ]; then
            ATTACH="$PPTX_PATH"
          fi

          if [ -n "$PDF_PATH" ] && [ -f "$PDF_PATH" ]; then
            if [ -n "$ATTACH" ]; then
              ATTACH="$ATTACH,$PDF_PATH"
            else
              ATTACH="$PDF_PATH"
            fi
          fi

          echo "files=$ATTACH" >> "$GITHUB_OUTPUT"

      - name: Send Email
        if: steps.detect.outputs.found == 'true' && steps.email_check.outputs.configured == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: nakashima.keitarou@gmail.com
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "ğŸ“Š æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰: ${{ steps.resolve.outputs.display_name }} (PPTX + PDF)"
          to: nakashima.keitarou@gmail.com
          from: nakashima.keitarou@gmail.com
          body: |
            æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

            ãƒ•ã‚¡ã‚¤ãƒ«å: ${{ steps.resolve.outputs.display_name }}
            ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}
            ã‚³ãƒŸãƒƒãƒˆ: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}

            æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«:
            - PPTX: ${{ steps.resolve.outputs.pptx_basename }}
            - PDF: ${{ steps.resolve.outputs.pdf_basename }}

            GitHubä¸Šã§ã‚‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™:
            - PPTX: ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/${{ steps.resolve.outputs.pptx_path }}
            - PDF: ${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/${{ steps.resolve.outputs.pdf_path }}
          attachments: ${{ steps.attachments.outputs.files }}
